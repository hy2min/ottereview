package com.ssafy.ottereview.review.controller;

import com.ssafy.ottereview.account.repository.AccountRepository;
import com.ssafy.ottereview.githubapp.util.GithubAppUtil;
import com.ssafy.ottereview.repo.repository.RepoRepository;
import com.ssafy.ottereview.user.entity.CustomUserDetail;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.kohsuke.github.GHPullRequest;
import org.kohsuke.github.GHPullRequestReview;
import org.kohsuke.github.GHPullRequestReviewComment;
import org.kohsuke.github.GHRepository;
import org.kohsuke.github.GHUser;
import org.kohsuke.github.GitHub;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.client.RestTemplate;

@RestController
@RequestMapping("/api/{account-id}/{repo-id}/{pr-id}")
@RequiredArgsConstructor
@Slf4j
public class ReviewTestController {

    private final GithubAppUtil githubAppUtil;
    private final RepoRepository repoRepository;
    private final AccountRepository accountRepository;

    /**
     * Î¶¨Î∑∞ ÏÉùÏÑ± (REST API ÏßÅÏ†ë Ìò∏Ï∂ú)
     */
    @PostMapping("/reviews/test")
    public ResponseEntity<?> createReviewTest(
            @PathVariable("account-id") Long accountId,
            @PathVariable("repo-id") Long repoId,
            @PathVariable("pr-id") Long prId,
            @AuthenticationPrincipal CustomUserDetail userDetail) {

        try {
            if (userDetail == null || userDetail.getUser() == null) {
                throw new RuntimeException("Î°úÍ∑∏Ïù∏ Ïú†Ï†Ä Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
            }

            String githubUsername = userDetail.getUser().getGithubUsername();

            // installationIdÎ°ú GitHub App ÌÜ†ÌÅ∞ Î∞úÍ∏â
            Long installationId = accountRepository.findById(accountId)
                    .orElseThrow(() -> new RuntimeException("Account not found"))
                    .getInstallationId();
            String token = githubAppUtil.getInstallationToken(installationId);

            // Î†àÌè¨ÏßÄÌÜ†Î¶¨ Ï†ÑÏ≤¥ Ïù¥Î¶Ñ Ï°∞Ìöå
            String repoFullName = repoRepository.findById(repoId)
                    .orElseThrow(() -> new RuntimeException("Repository not found"))
                    .getFullName();

            // 3. REST API URL
            String url = String.format("https://api.github.com/repos/%s/pulls/%d/reviews", repoFullName, prId);

            // 4. ÏöîÏ≤≠ Î∞îÎîî (ÌÖåÏä§Ìä∏Ïö© ÌïòÎìúÏΩîÎî©)
            Map<String, Object> requestBody = Map.of(
                    "body", """
                ### ‚úèÔ∏è **Reviewer: @%s**
                
                > %s
                """.formatted(githubUsername, "Ïù¥Í±∞Ïä® ÏµúÏ¢ÖÏûÖÎãàÎã§"),
                    "event", "APPROVE",
                    "comments", List.of(
                            Map.of(
                                    "path", "test.txt",
                                    "position", 7,
                                    "body", """
                                ** üëÄReviewer: @%s**
                                Î©ÄÎùºÎ©ÄÎùºÏö©
                                """.formatted(githubUsername)
                            )
                    )
            );


            // 5. HTTP Ìó§Îçî ÏÑ§Ï†ï
            HttpHeaders headers = new HttpHeaders();
            headers.setBearerAuth(token);
            headers.setContentType(MediaType.APPLICATION_JSON);

            // ÏöîÏ≤≠ Ï†ÑÏÜ°
            RestTemplate restTemplate = new RestTemplate();
            HttpEntity<Map<String, Object>> entity = new HttpEntity<>(requestBody, headers);
            ResponseEntity<String> response = restTemplate.postForEntity(url, entity, String.class);

            // ÏÉùÏÑ± ÌõÑ PR Î¶¨Î∑∞ Ï†ïÎ≥¥ Î∞òÌôò
            GitHub github = githubAppUtil.getGitHub(installationId);
            GHRepository repository = github.getRepository(repoFullName);
            GHPullRequest pullRequest = repository.getPullRequest(prId.intValue());

            Map<String, Object> result = new HashMap<>();
            result.put("prInfo", getPullRequestInfo(pullRequest));
            result.put("reviews", getReviewsInfo(pullRequest));
            result.put("reviewComments", getReviewCommentsInfo(pullRequest));
            result.put("requestedReviewers", getRequestedReviewersInfo(pullRequest));

            return ResponseEntity.ok(result);

        } catch (Exception e) {
            log.error("Î¶¨Î∑∞ ÏÉùÏÑ± Ïã§Ìå®", e);
            return ResponseEntity.internalServerError().body("Î¶¨Î∑∞ ÏÉùÏÑ± Ïã§Ìå®: " + e.getMessage());
        }
    }

    @GetMapping("/review-info")
    public ResponseEntity<Map<String, Object>> getReviewInfo(
            @PathVariable("pr-id") Long prId,
            @PathVariable("account-id") Long accountId,
            @PathVariable("repo-id") Long repoId,
            @AuthenticationPrincipal CustomUserDetail userDetail) {

        try {
            // getReferenceById ÎåÄÏã† findById ÏÇ¨Ïö© (Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå)
            Long installationId = accountRepository.findById(accountId)
                    .orElseThrow(
                            () -> new RuntimeException("Account not found with id: " + accountId))
                    .getInstallationId();
            GitHub github = githubAppUtil.getGitHub(installationId);

            // Î†àÌè¨ÏßÄÌÜ†Î¶¨ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞ (findById ÏÇ¨Ïö©)
            String repoFullName = repoRepository.findById(repoId)
                    .orElseThrow(
                            () -> new RuntimeException("Repository not found with id: " + repoId))
                    .getFullName();
            GHRepository repository = github.getRepository(repoFullName);

            // PR Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            GHPullRequest pullRequest = repository.getPullRequest(prId.intValue());

            Map<String, Object> result = new HashMap<>();

            // 1. PR Í∏∞Î≥∏ Ï†ïÎ≥¥
            result.put("prInfo", getPullRequestInfo(pullRequest));

            // 2. Î¶¨Î∑∞ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            result.put("reviews", getReviewsInfo(pullRequest));

            // 3. Î¶¨Î∑∞ ÎåìÍ∏Ä Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            result.put("reviewComments", getReviewCommentsInfo(pullRequest));

            // 4. ÏöîÏ≤≠Îêú Î¶¨Î∑∞Ïñ¥ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            result.put("requestedReviewers", getRequestedReviewersInfo(pullRequest));

            log.info("Successfully retrieved review info for PR #{} in repo {}", prId,
                    repoFullName);
            return ResponseEntity.ok(result);

        } catch (Exception e) {
            log.error("Error retrieving review info for PR #{}", prId, e);
            return ResponseEntity.internalServerError()
                    .body(Map.of("error",
                            "Failed to retrieve review information: " + e.getMessage()));
        }
    }

    /**
     * PR Í∏∞Î≥∏ Ï†ïÎ≥¥ Ï∂îÏ∂ú
     */
    private Map<String, Object> getPullRequestInfo(GHPullRequest pr) throws Exception {
        Map<String, Object> prInfo = new HashMap<>();
        prInfo.put("id", pr.getId());
        prInfo.put("number", pr.getNumber());
        prInfo.put("title", pr.getTitle());
        prInfo.put("body", pr.getBody());
        prInfo.put("state", pr.getState().toString());
        prInfo.put("createdAt", pr.getCreatedAt());
        prInfo.put("updatedAt", pr.getUpdatedAt());
        prInfo.put("author", pr.getUser().getLogin());
        prInfo.put("authorName", pr.getUser().getName());
        prInfo.put("headBranch", pr.getHead().getRef());
        prInfo.put("baseBranch", pr.getBase().getRef());
        prInfo.put("mergeable", pr.getMergeable());
        prInfo.put("merged", pr.isMerged());
        return prInfo;
    }

    /**
     * Î¶¨Î∑∞ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
     */
    private List<Map<String, Object>> getReviewsInfo(GHPullRequest pr) throws Exception {
        List<Map<String, Object>> reviews = new ArrayList<>();

        for (GHPullRequestReview review : pr.listReviews()) {
            Map<String, Object> reviewInfo = new HashMap<>();
            reviewInfo.put("id", review.getId());
            reviewInfo.put("state", review.getState()
                    .toString()); // APPROVED, CHANGES_REQUESTED, COMMENTED, DISMISSED
            reviewInfo.put("body", review.getBody());
            reviewInfo.put("submittedAt", review.getSubmittedAt());
            reviewInfo.put("commitId", review.getCommitId());

            // Î¶¨Î∑∞Ïñ¥ Ï†ïÎ≥¥
            GHUser reviewer = review.getUser();
            Map<String, Object> reviewerInfo = new HashMap<>();
            reviewerInfo.put("login", reviewer.getLogin());
            reviewerInfo.put("name", reviewer.getName());
            reviewerInfo.put("avatarUrl", reviewer.getAvatarUrl());
            reviewerInfo.put("htmlUrl", reviewer.getHtmlUrl());
            reviewInfo.put("reviewer", reviewerInfo);

            reviews.add(reviewInfo);
        }

        return reviews;
    }

    /**
     * Î¶¨Î∑∞ ÎåìÍ∏Ä Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
     */
    private List<Map<String, Object>> getReviewCommentsInfo(GHPullRequest pr) throws Exception {
        List<Map<String, Object>> comments = new ArrayList<>();

        for (GHPullRequestReviewComment comment : pr.listReviewComments()) {
            Map<String, Object> commentInfo = new HashMap<>();
            commentInfo.put("id", comment.getId());
            commentInfo.put("body", comment.getBody());
            commentInfo.put("path", comment.getPath()); // ÌååÏùº Í≤ΩÎ°ú
            commentInfo.put("position", comment.getPosition()); // ÌååÏùº ÎÇ¥ ÏúÑÏπò
            commentInfo.put("line", comment.getLine()); // ÎùºÏù∏ Î≤àÌò∏
            commentInfo.put("side", comment.getSide()); // LEFT ÎòêÎäî RIGHT
            commentInfo.put("startLine", comment.getStartLine());
            commentInfo.put("startSide", comment.getStartSide());
            commentInfo.put("createdAt", comment.getCreatedAt());
            commentInfo.put("updatedAt", comment.getUpdatedAt());
            commentInfo.put("commitId", comment.getCommitId());
            commentInfo.put("originalCommitId", comment.getOriginalCommitId());
            commentInfo.put("diffHunk", comment.getDiffHunk());
            commentInfo.put("pullRequestReviewId", comment.getPullRequestReviewId());

            // ÎåìÍ∏Ä ÏûëÏÑ±Ïûê Ï†ïÎ≥¥
            GHUser commenter = comment.getUser();
            Map<String, Object> commenterInfo = new HashMap<>();
            commenterInfo.put("login", commenter.getLogin());
            commenterInfo.put("name", commenter.getName());
            commenterInfo.put("avatarUrl", commenter.getAvatarUrl());
            commenterInfo.put("htmlUrl", commenter.getHtmlUrl());
            commentInfo.put("commenter", commenterInfo);

            comments.add(commentInfo);
        }

        return comments;
    }

    /**
     * ÏöîÏ≤≠Îêú Î¶¨Î∑∞Ïñ¥ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
     */
    private List<Map<String, Object>> getRequestedReviewersInfo(GHPullRequest pr) throws Exception {
        List<Map<String, Object>> requestedReviewers = new ArrayList<>();

        for (GHUser reviewer : pr.getRequestedReviewers()) {
            Map<String, Object> reviewerInfo = new HashMap<>();
            reviewerInfo.put("login", reviewer.getLogin());
            reviewerInfo.put("name", reviewer.getName());
            reviewerInfo.put("avatarUrl", reviewer.getAvatarUrl());
            reviewerInfo.put("htmlUrl", reviewer.getHtmlUrl());
            reviewerInfo.put("type", reviewer.getType());

            requestedReviewers.add(reviewerInfo);
        }

        return requestedReviewers;
    }

    /**
     * ÌäπÏ†ï Î¶¨Î∑∞Ïñ¥Ïùò Î¶¨Î∑∞ ÏÉÅÌÉú ÌôïÏù∏
     */
    @GetMapping("/reviewer-status/{reviewerLogin}")
    public ResponseEntity<Map<String, Object>> getReviewerStatus(
            @PathVariable("pr-id") Long prId,
            @PathVariable("account-id") Long accountId,
            @PathVariable("repo-id") Long repoId,
            @PathVariable("reviewerLogin") String reviewerLogin,
            @AuthenticationPrincipal CustomUserDetail userDetail) {

        try {
            Long installationId = accountRepository.findById(accountId)
                    .orElseThrow(
                            () -> new RuntimeException("Account not found with id: " + accountId))
                    .getInstallationId();
            GitHub github = githubAppUtil.getGitHub(installationId);

            String repoFullName = repoRepository.findById(repoId)
                    .orElseThrow(
                            () -> new RuntimeException("Repository not found with id: " + repoId))
                    .getFullName();
            GHRepository repository = github.getRepository(repoFullName);
            GHPullRequest pullRequest = repository.getPullRequest(prId.intValue());

            Map<String, Object> result = new HashMap<>();
            result.put("reviewerLogin", reviewerLogin);
            result.put("hasReviewed", false);
            result.put("latestReviewState", null);
            result.put("reviewCount", 0);

            int reviewCount = 0;
            String latestState = null;

            // Ìï¥Îãπ Î¶¨Î∑∞Ïñ¥Ïùò Î™®Îì† Î¶¨Î∑∞ ÌôïÏù∏
            for (GHPullRequestReview review : pullRequest.listReviews()) {
                if (review.getUser().getLogin().equals(reviewerLogin)) {
                    reviewCount++;
                    latestState = review.getState().toString();
                    result.put("hasReviewed", true);
                }
            }

            result.put("reviewCount", reviewCount);
            result.put("latestReviewState", latestState);

            return ResponseEntity.ok(result);

        } catch (Exception e) {
            log.error("Error getting reviewer status for {}", reviewerLogin, e);
            return ResponseEntity.internalServerError()
                    .body(Map.of("error", "Failed to get reviewer status: " + e.getMessage()));
        }
    }

    /**
     * ÏïÑÏßÅ Î¶¨Î∑∞ÌïòÏßÄ ÏïäÏùÄ Î¶¨Î∑∞Ïñ¥ Î™©Î°ù Ï°∞Ìöå
     */
    @GetMapping("/pending-reviewers")
    public ResponseEntity<List<Map<String, Object>>> getPendingReviewers(
            @PathVariable("pr-id") Long prId,
            @PathVariable("account-id") Long accountId,
            @PathVariable("repo-id") Long repoId,
            @AuthenticationPrincipal CustomUserDetail userDetail) {

        try {
            Long installationId = accountRepository.findById(accountId)
                    .orElseThrow(
                            () -> new RuntimeException("Account not found with id: " + accountId))
                    .getInstallationId();
            GitHub github = githubAppUtil.getGitHub(installationId);

            String repoFullName = repoRepository.findById(repoId)
                    .orElseThrow(
                            () -> new RuntimeException("Repository not found with id: " + repoId))
                    .getFullName();
            GHRepository repository = github.getRepository(repoFullName);
            GHPullRequest pullRequest = repository.getPullRequest(prId.intValue());

            List<Map<String, Object>> pendingReviewers = new ArrayList<>();

            // ÏöîÏ≤≠Îêú Î¶¨Î∑∞Ïñ¥ Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
            List<GHUser> requestedReviewers = pullRequest.getRequestedReviewers();

            // Ïù¥ÎØ∏ Î¶¨Î∑∞Ìïú ÏÇ¨Ïö©ÏûêÎì§Ïùò Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥ ÏàòÏßë
            List<String> reviewedUsers = new ArrayList<>();
            for (GHPullRequestReview review : pullRequest.listReviews()) {
                String reviewerLogin = review.getUser().getLogin();
                if (!reviewedUsers.contains(reviewerLogin)) {
                    reviewedUsers.add(reviewerLogin);
                }
            }

            // ÏöîÏ≤≠Îêú Î¶¨Î∑∞Ïñ¥ Ï§ë ÏïÑÏßÅ Î¶¨Î∑∞ÌïòÏßÄ ÏïäÏùÄ ÏÇ¨ÎûåÎì§Îßå ÌïÑÌÑ∞ÎßÅ
            for (GHUser reviewer : requestedReviewers) {
                if (!reviewedUsers.contains(reviewer.getLogin())) {
                    Map<String, Object> reviewerInfo = new HashMap<>();
                    reviewerInfo.put("login", reviewer.getLogin());
                    reviewerInfo.put("name", reviewer.getName());
                    reviewerInfo.put("avatarUrl", reviewer.getAvatarUrl());
                    reviewerInfo.put("htmlUrl", reviewer.getHtmlUrl());
                    pendingReviewers.add(reviewerInfo);
                }
            }

            return ResponseEntity.ok(pendingReviewers);

        } catch (Exception e) {
            log.error("Error getting pending reviewers for PR #{}", prId, e);
            return ResponseEntity.internalServerError().build();
        }
    }
}